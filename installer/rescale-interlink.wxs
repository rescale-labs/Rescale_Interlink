<?xml version="1.0" encoding="UTF-8"?>
<!--
  Rescale Interlink Windows Installer
  WiX v4 Configuration

  Build requirements:
  * WiX Toolset v4+ (dotnet tool install global wix)
  * Windows SDK (for signtool)

  Build command:
    wix build installer\rescale-interlink.wxs -o bin\RescaleInterlink.msi
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <!-- Product definition -->
  <Package Name="Rescale Interlink"
           Manufacturer="Rescale, Inc."
           Version="4.0.7.0"
           UpgradeCode="8B7E9C4A-3F2D-4E1A-B5C6-7D8E9F0A1B2C"
           Scope="perMachine"
           Language="1033"
           InstallerVersion="500">

    <SummaryInformation Description="Rescale Interlink - Unified CLI and GUI for Rescale HPC platform"
                        Manufacturer="Rescale, Inc." />

    <!-- Upgrade handling -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  AllowSameVersionUpgrades="yes" />

    <!-- Media definition -->
    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Features -->
    <Feature Id="MainFeature" Title="Rescale Interlink" Level="1">
      <ComponentGroupRef Id="MainComponents" />
      <ComponentGroupRef Id="WebView2Components" />
      <ComponentGroupRef Id="StartMenuShortcuts" />
    </Feature>

    <Feature Id="ServiceFeature" Title="Auto-Download Service" Level="1">
      <ComponentGroupRef Id="ServiceComponents" />
    </Feature>

    <Feature Id="TrayFeature" Title="System Tray Companion" Level="1">
      <ComponentGroupRef Id="TrayComponents" />
    </Feature>

    <!-- Custom actions -->
    <!-- v4.0.7 M6: Changed Return from "check" to "ignore" to prevent service install
         failure from blocking entire application installation. The service is optional
         and the GUI/CLI work independently without it. -->
    <CustomAction Id="InstallService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]rescale-int.exe service install"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="UninstallService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]rescale-int.exe service uninstall"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="StartService"
                  Directory="INSTALLFOLDER"
                  ExeCommand="[INSTALLFOLDER]rescale-int.exe service start"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- v4.0.8: Launch tray icon immediately after install using WixShellExec -->
    <!-- Set target executable - [#FileId] resolves to installed path -->
    <SetProperty Id="WixShellExecTarget" Value="[#TrayExe]" After="CostFinalize" Sequence="execute" />

    <CustomAction Id="LaunchTray"
                  BinaryRef="Wix4UtilCA_X64"
                  DllEntry="WixShellExec"
                  Execute="immediate"
                  Return="ignore" />

    <!-- Install sequence -->
    <InstallExecuteSequence>
      <Custom Action="UninstallService" Before="RemoveFiles" Condition="REMOVE~=&quot;ALL&quot;" />
      <Custom Action="InstallService" After="InstallFiles" Condition="NOT REMOVE" />
      <Custom Action="StartService" After="InstallService" Condition="NOT REMOVE" />
      <Custom Action="LaunchTray" After="InstallFinalize" Condition="NOT Installed AND NOT REMOVE" />
    </InstallExecuteSequence>

    <!-- UI reference - WiX v4 uses ui:WixUI from UI extension -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <ui:WixUI Id="WixUI_FeatureTree" />

  </Package>

  <!-- Directory structure -->
  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="MANUFACTURERFOLDER" Name="Rescale">
        <Directory Id="INSTALLFOLDER" Name="Interlink">
          <Directory Id="WEBVIEW2FOLDER" Name="webview2" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Rescale Interlink" />
    </StandardDirectory>
  </Fragment>

  <!-- Main application components -->
  <Fragment>
    <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
      <!-- v4.0.2: GUI application (Wails-based, with embedded frontend) -->
      <Component Id="GuiExecutable" Guid="1A2B3C4D-5E6F-7A8B-9C0D-E1F2A3B4C5D6">
        <File Id="RescaleIntGuiExe" Source="$(var.BuildDir)\rescale-int-gui.exe" KeyPath="yes">
          <Shortcut Id="DesktopShortcut"
                    Directory="DesktopFolder"
                    Name="Rescale Interlink"
                    WorkingDirectory="INSTALLFOLDER"
                    Advertise="yes" />
        </File>
      </Component>

      <!-- v4.0.2: CLI tool (standalone Go binary) -->
      <Component Id="CliExecutable" Guid="1A2B3C4D-5E6F-7A8B-9C0D-E1F2A3B4C5D7">
        <File Id="RescaleIntExe" Source="$(var.BuildDir)\rescale-int.exe" KeyPath="yes" />
      </Component>

      <Component Id="ReadmeFile" Guid="2B3C4D5E-6F7A-8B9C-0D1E-F2A3B4C5D6E7">
        <File Id="ReadmeTxt" Source="$(var.SourceDir)\README.txt" KeyPath="yes" />
      </Component>

      <Component Id="LicenseFile" Guid="3C4D5E6F-7A8B-9C0D-1E2F-A3B4C5D6E7F8">
        <File Id="LicenseTxt" Source="$(var.SourceDir)\LICENSE.txt" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- WebView2 Fixed Version Runtime components -->
  <!-- Bundled runtime enables GUI on Windows Server 2019 without system-wide installation -->
  <Fragment>
    <ComponentGroup Id="WebView2Components" Directory="WEBVIEW2FOLDER">
      <!-- Use Files element for dynamic harvesting of webview2 folder contents -->
      <Files Include="$(var.BuildDir)\webview2\**">
        <Exclude Files="$(var.BuildDir)\webview2\**\.gitkeep" />
      </Files>
    </ComponentGroup>
  </Fragment>

  <!-- Service components -->
  <Fragment>
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceConfig" Guid="4D5E6F7A-8B9C-0D1E-2F3A-B4C5D6E7F8A9">
        <!-- Service is registered via custom action using CLI -->
        <RegistryKey Root="HKLM" Key="SOFTWARE\Rescale\Interlink">
          <RegistryValue Name="ServiceInstalled" Type="integer" Value="1" KeyPath="yes" />
        </RegistryKey>
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Tray companion components -->
  <Fragment>
    <ComponentGroup Id="TrayComponents" Directory="INSTALLFOLDER">
      <Component Id="TrayExecutable" Guid="5E6F7A8B-9C0D-1E2F-3A4B-C5D6E7F8A9B0">
        <File Id="TrayExe" Source="$(var.BuildDir)\rescale-int-tray.exe" KeyPath="yes" />

        <!-- Create scheduled task for tray auto-start -->
        <RegistryKey Root="HKCU" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run">
          <RegistryValue Name="RescaleInterlinkTray"
                         Type="string"
                         Value="[INSTALLFOLDER]rescale-int-tray.exe" />
        </RegistryKey>
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Start menu shortcuts -->
  <Fragment>
    <ComponentGroup Id="StartMenuShortcuts" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="6F7A8B9C-0D1E-2F3A-4B5C-D6E7F8A9B0C1">
        <!-- v4.0.2: Updated to use rescale-int-gui.exe for GUI, rescale-int.exe for CLI -->
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Rescale Interlink"
                  Description="Unified CLI and GUI for Rescale HPC platform"
                  Target="[INSTALLFOLDER]rescale-int-gui.exe"
                  WorkingDirectory="INSTALLFOLDER" />

        <Shortcut Id="CLIStartMenuShortcut"
                  Name="Rescale Interlink (Command Line)"
                  Description="Open command prompt with Rescale Interlink CLI"
                  Target="[SystemFolder]cmd.exe"
                  Arguments="/k &quot;cd /d [INSTALLFOLDER] &amp;&amp; rescale-int.exe --help&quot;"
                  WorkingDirectory="INSTALLFOLDER" />

        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="SOFTWARE\Rescale\Interlink" Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <StandardDirectory Id="DesktopFolder" />
  </Fragment>

</Wix>
